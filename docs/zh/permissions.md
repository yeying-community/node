# 权限模型

本节描述当前后端的权限模型与授权边界（以现有实现为准）。

## 认证层（已实现）
- 所有 `/api/v1/*` 业务接口默认要求 `Authorization: Bearer <token>`。
- 允许两种 token：
  - **SIWE (JWT)**
  - **UCAN**（需满足 `aud` + `cap`）

## UCAN 授权规则（已实现）
服务端严格校验：
- `aud` == `UCAN_AUD`（完全匹配）
- capability 包含 `{ resource: UCAN_RESOURCE, action: UCAN_ACTION }`
- `exp` 未过期、证明链有效

> 注意：前端必须生成与后端 `UCAN_AUD` 完全一致的 audience，否则返回 `UCAN audience mismatch`。

## 角色与用户状态（已定义）
用户状态与角色在接口协议中有枚举定义，但目前**未被强制使用**：
- `UserRoleEnum`: `OWNER`, `NORMAL`, `UNKNOWN`
- `UserStatusEnum`: `ACTIVE`, `OFFLINE`, `DISABLE`, `LOCK`, `AUDIT`, `REFUSED`, ...

## 当前实际授权边界（现状）
- **已生效**：Token 必须通过（JWT/UCAN）。
- **已生效**：资源归属校验（应用/服务创建、更新、删除、上架/下架仅 owner 可操作；管理员可覆盖）。
- **已生效**：审核权限（仅审批人可 approve/reject）。
- **已生效**：多审批人阈值（`audit.approvers` + `audit.requiredApprovals`），达到阈值才通过；任一驳回即拒绝。
- **已生效**：用户冻结/禁用限制（冻结/禁用用户禁止发布/审批）。
- **已生效**：管理员前缀校验（`/api/v1/admin/*`，角色 `OWNER` 或 `ADMIN_DIDS` 白名单）。
- **未强制**：角色/状态与细粒度权限控制（目前业务接口基本不校验用户角色）。
- **签名校验**：已对**上架申请/审核通过/驳回**启用钱包签名校验（personal_sign）；其他签名仍未强制。

## 权限缺口与待办（建议优先级）
1. **角色校验**：将 `OWNER/NORMAL` 与审批、上下架等操作绑定。
2. **资源归属校验**：保持前后端一致的 owner-only 更新/上架/下架约束。
3. **审核权限**：仅审批人/管理员可 approve/reject；记录审批人身份（审批人校验已落地）。
4. **用户状态控制**：冻结/解冻仅管理员可执行，冻结用户禁止发布/审批。
5. **签名校验扩展**：是否将签名校验覆盖到创建/修改/申请等更多流程。
6. **在线状态约束**：上线需审核通过，搜索默认仅返回已上线资源（已落地）。

## 推荐的目标权限模型（规划）
以下是推荐的权限约束（可作为后续开发目标）：

### 角色权限建议
- `OWNER`：审批/治理权限（审核、封禁、上下架）
- `NORMAL`：创建与管理自己的应用/服务、提交申请
- `UNKNOWN`：只读或拒绝

### 资源级权限建议
- **应用**：
  - 仅创建者可更新/下架
  - 审核通过后才能上线
- **服务**：
  - 仅创建者可更新/下架
  - 审核通过后才能上线
- **审核**：
  - 仅审核人/管理员可审批
- **用户状态**：
  - 仅管理员可冻结/解锁

> 说明：以上为规划建议，当前代码尚未强制执行。
